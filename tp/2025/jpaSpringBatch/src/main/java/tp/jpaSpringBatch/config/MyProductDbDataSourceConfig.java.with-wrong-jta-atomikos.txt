package tp.jpaSpringBatch.config;

import javax.sql.DataSource;
import javax.sql.XADataSource;

import com.atomikos.spring.AtomikosDataSourceBean;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MyProductDbDataSourceConfig {

    @Value("${spring.productdb.datasource.xa-data-source-class-name}") //ex: com.mysql.cj.jdbc.MysqlXADataSource
    private String xaDataSourceClassName;

	/*
	 NB: in application.properties
	 NOT spring.datasource.url=jdbc:h2:mem:outputDb
	 BUT spring.productdb.datasource.url=jdbc:h2:~/outputDb
	 and spring.productdb.datasource.driverClassName=org.h2.Driver
	 and spring.productdb.datasource.username=sa
        spring.productdb.datasource.password=
	 */
	@Bean @Qualifier("productdb")
  @ConfigurationProperties("spring.productdb.datasource")
  public DataSourceProperties productdbDataSourceProperties() {
      return new DataSourceProperties();
  }
	
	@Bean(name="productdbDataSource") @Qualifier("productdb")
    // NOT @Primary !!!
	public DataSource productdbDataSource(@Qualifier("productdb") DataSourceProperties productdbDataSourceProperties)
                          throws Exception {
	   /* return productdbDataSourceProperties
	      .initializeDataSourceBuilder()
	      .build();*/
        //Atomikos DataSource (XA):

        Class <DataSource> xaDataSourceClass = (Class<DataSource>)
                Class.forName(this.xaDataSourceClassName);

        XADataSource xaDs = (XADataSource)
                productdbDataSourceProperties
                        .initializeDataSourceBuilder()
                        .type(xaDataSourceClass)
                        .build();

        AtomikosDataSourceBean atomikosXaDataSource = new AtomikosDataSourceBean();
        atomikosXaDataSource.setXaDataSource(xaDs);
        atomikosXaDataSource.setUniqueResourceName("xa_job_productdb");
        atomikosXaDataSource.setMaxPoolSize(30);
        return atomikosXaDataSource;
	}
	

	
}
